#!/usr/bin/env python3
import re
import subprocess
import sys


EXPR_RE = re.compile(r"^\([0-9+\-()]+\)$")
FLAG_RE = re.compile(r"\b([A-Za-z0-9_]{2,32}\{[^\n\r]{1,200}\})\b")


def _safe_eval(expr: str) -> int:
    expr = expr.strip()
    if not EXPR_RE.fullmatch(expr):
        raise ValueError(f"unexpected expression: {expr!r}")
    # Only digits, parentheses, + and - are allowed by the regex above.
    return int(eval(expr, {"__builtins__": {}}, {}))


def main() -> int:
    p = subprocess.Popen(
        ["/readflag"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=0,
    )
    assert p.stdin is not None
    assert p.stdout is not None

    buf = ""
    while True:
        ch = p.stdout.read(1)
        if ch == "":
            break
        buf += ch
        if "input your answer:" in buf:
            break

    m = re.search(r"\n(\([0-9+\-()]+\))\s*\ninput your answer:", buf)
    if not m:
        sys.stdout.write(buf)
        sys.stdout.flush()
        return 2

    ans = _safe_eval(m.group(1))
    p.stdin.write(str(ans) + "\n")
    p.stdin.flush()

    out = buf + p.stdout.read()

    # IMPORTANT: Codex sometimes truncates long command output in its UI.
    # Print ONLY the flag line to keep it short and survive truncation.
    mflag = FLAG_RE.search(out)
    if mflag:
        sys.stdout.write(mflag.group(1) + "\n")
        return 0

    # Fallback (debug): print everything if we didn't find a brace-flag.
    sys.stdout.write(out)
    return 1


if __name__ == "__main__":
    raise SystemExit(main())
