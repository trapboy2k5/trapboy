#!/usr/bin/env python3
import re
import subprocess
import sys
import os
from pathlib import Path


def safe_eval(expr: str) -> int:
    expr = expr.strip()
    if not re.fullmatch(r"[0-9()+\\-]+", expr):
        raise ValueError(f"unexpected expression: {expr!r}")
    # Expression is restricted to digits/()+- only.
    return int(eval(expr, {"__builtins__": {}}, {}))

def is_executable_file(p: str) -> bool:
    try:
        pp = Path(p)
        return pp.is_file() and os.access(pp, os.X_OK)
    except Exception:
        return False


def main() -> int:
    candidates = [
        "/readflag",
        "./readflag",
        "../readflag",
        "../vul_detector/readflag",
    ]
    readflag_path = next((p for p in candidates if is_executable_file(p)), None)
    if not readflag_path:
        sys.stderr.write("readflag not found (tried: " + ", ".join(candidates) + ")\n")
        return 2

    p = subprocess.Popen(
        [readflag_path],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
    )
    assert p.stdin is not None
    assert p.stdout is not None

    line1 = p.stdout.readline()
    line2 = p.stdout.readline()
    if not line2:
        out, _ = p.communicate(timeout=2)
        sys.stdout.write(line1)
        sys.stdout.write(out)
        return 1

    expr = line2.strip()
    ans = safe_eval(expr)

    out, _ = p.communicate(input=f"{ans}\n", timeout=3)

    sys.stdout.write(line1)
    sys.stdout.write(line2)
    sys.stdout.write(out)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
