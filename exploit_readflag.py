#!/usr/bin/env python3
import re
import subprocess
import sys


EXPR_RE = re.compile(r"^\([0-9+\-()]+\)$")


def _safe_eval(expr: str) -> int:
    expr = expr.strip()
    if not EXPR_RE.fullmatch(expr):
        raise ValueError(f"unexpected expression: {expr!r}")
    # Only digits, parentheses, + and - are allowed by the regex above.
    return int(eval(expr, {"__builtins__": {}}, {}))


def main() -> int:
    p = subprocess.Popen(
        ["/readflag"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=0,
    )
    assert p.stdin is not None
    assert p.stdout is not None

    buf = ""
    while True:
        ch = p.stdout.read(1)
        if ch == "":
            break
        buf += ch
        if "input your answer:" in buf:
            break

    # Expect the expression to be on its own line before the prompt.
    # Example:
    #   Solve the easy challenge first
    #   (((1)+(2))-(3))
    #   input your answer:
    m = re.search(r"\n(\([0-9+\-()]+\))\s*\ninput your answer:", buf)
    if not m:
        sys.stdout.write(buf)
        sys.stdout.flush()
        return 2

    expr = m.group(1)
    ans = _safe_eval(expr)

    p.stdin.write(str(ans) + "\n")
    p.stdin.flush()

    rest = p.stdout.read()
    sys.stdout.write(buf + rest)
    sys.stdout.flush()
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

